# Unified Dockerfile - All components in a single container
# Includes: PostgreSQL, Redis, API, Dashboard (nginx)

FROM node:20-alpine AS builder

WORKDIR /app

# Install pnpm via corepack
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy workspace configuration files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./
COPY .npmrc* ./
COPY tsconfig.base.json ./

# Copy package.json files for all packages
COPY packages/shared/package.json ./packages/shared/
COPY apps/api/package.json ./apps/api/
COPY apps/dashboard/package.json ./apps/dashboard/

# Configure pnpm for hoisted node_modules (makes binaries accessible)
RUN echo "shamefully-hoist=true" >> .npmrc && \
    echo "node-linker=hoisted" >> .npmrc

# Install all dependencies
RUN pnpm install --frozen-lockfile || pnpm install

# Install typescript globally as fallback
RUN npm install -g typescript

# Copy source files
COPY packages/shared ./packages/shared
COPY apps/api ./apps/api
COPY apps/dashboard ./apps/dashboard

# Build shared package first
RUN cd packages/shared && pnpm run build || tsc

# Build API
RUN cd apps/api && pnpm run build || tsc

# Build Dashboard (React/Vite)
RUN cd apps/dashboard && pnpm run build

# Production stage - unified container with all services
FROM alpine:3.19 AS runner

# Install required packages
RUN apk add --no-cache \
    nodejs \
    npm \
    nginx \
    postgresql16 \
    postgresql16-contrib \
    redis \
    supervisor \
    bash \
    curl

# Create directories
RUN mkdir -p /app /run/postgresql /run/nginx /var/log/supervisor /data/postgres /data/redis

# Set up PostgreSQL
ENV PGDATA=/data/postgres
RUN chown -R postgres:postgres /data/postgres /run/postgresql
RUN su postgres -c "initdb -D /data/postgres"

# Configure PostgreSQL
RUN echo "host all all 0.0.0.0/0 md5" >> /data/postgres/pg_hba.conf && \
    echo "listen_addresses = 'localhost'" >> /data/postgres/postgresql.conf && \
    echo "port = 5432" >> /data/postgres/postgresql.conf

# Set up Redis
RUN chown -R redis:redis /data/redis

# Copy application files
WORKDIR /app

# Copy built files from builder (including node_modules)
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/packages/shared ./packages/shared
COPY --from=builder /app/apps/api ./apps/api

# Copy dashboard static files
COPY --from=builder /app/apps/dashboard/dist /usr/share/nginx/html

# Copy nginx configuration
COPY docker/nginx.unified.conf /etc/nginx/http.d/default.conf

# Copy supervisord configuration
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Copy initialization script
COPY docker/init-db.sh /docker-entrypoint-initdb.d/init-db.sh
RUN chmod +x /docker-entrypoint-initdb.d/init-db.sh

# Copy entrypoint script
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment variables
ENV NODE_ENV=production
ENV DATABASE_URL=postgresql://cda:cda_password@localhost:5432/cda
ENV REDIS_URL=redis://localhost:6379
ENV API_PORT=3000
ENV HOST=0.0.0.0

# Expose ports
# 80 - Nginx (Dashboard + API proxy)
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost/api/health/live || exit 1

# Start all services via supervisord
ENTRYPOINT ["/entrypoint.sh"]
CMD ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf", "-n"]
